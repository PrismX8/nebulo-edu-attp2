<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="description" content="Nebulo Education Plus is a math-focused experience offering educational algebra practice tests to strengthen advanced math skills.">
  <meta name="keywords" content="math, algebra, advanced math practice test, educational exercises, study tools">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Nebulo Education Plus - Educational Algebra Practice Tests">
  <meta property="og:description" content="Step into a dedicated math site built around educational algebra practice tests designed to enhance advanced math skills.">
<title>Nebulo Education Plus ‚Äî Algebra Practice Tests</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f1117;
      --bg-secondary: #151821;
      --bg-surface: rgba(30, 35, 48, 0.85);
      --bg-surface-light: rgba(40, 45, 58, 0.7);
      --border-color: rgba(100, 120, 160, 0.2);
      --text-primary: #ffffff;
      --text-secondary: #b0b7c7;
      --accent-blue: #3498db;
      --accent-blue-light: #5dade2;
      --accent-blue-dark: #1c6ea4;
      --accent-blue-transparent: rgba(52, 152, 219, 0.1);
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      --shadow-sm: 0 4px 20px rgba(0, 0, 0, 0.2);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      color-scheme: dark;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    /* Smooth Grey Background Animation */
    .background-animation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
      overflow: hidden;
    }

    .background-animation::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        linear-gradient(45deg, 
          rgba(20, 22, 30, 0.8) 0%,
          rgba(25, 28, 38, 0.8) 25%,
          rgba(30, 33, 46, 0.8) 50%,
          rgba(25, 28, 38, 0.8) 75%,
          rgba(20, 22, 30, 0.8) 100%);
      animation: gradientShift 20s ease infinite;
      background-size: 400% 400%;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .background-animation::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(
        circle at 30% 30%,
        rgba(52, 152, 219, 0.05) 0%,
        transparent 40%
      ),
      radial-gradient(
        circle at 70% 70%,
        rgba(52, 152, 219, 0.03) 0%,
        transparent 40%
      );
      animation: float 40s linear infinite;
    }

    @keyframes float {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(-2%, 2%) rotate(1deg); }
      50% { transform: translate(0, 4%) rotate(0deg); }
      75% { transform: translate(2%, 2%) rotate(-1deg); }
      100% { transform: translate(0, 0) rotate(0deg); }
    }

    /* Subtle particles */
    .particles {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
    }

    .particle {
      position: absolute;
      width: 2px;
      height: 2px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      animation: particleFloat 20s linear infinite;
    }

    @keyframes particleFloat {
      0% {
        transform: translateY(100vh) translateX(0) rotate(0deg);
        opacity: 0;
      }
      10% { opacity: 0.3; }
      90% { opacity: 0.3; }
      100% {
        transform: translateY(-100px) translateX(100px) rotate(360deg);
        opacity: 0;
      }
    }

    /* Apps Sidebar */
    .apps-sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 380px;
      height: 100vh;
      background: rgba(15, 17, 23, 0.95);
      backdrop-filter: blur(20px);
      border-left: 1px solid var(--border-color);
      z-index: 1000;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      box-shadow: -20px 0 60px rgba(0, 0, 0, 0.3);
    }

    .apps-sidebar.active {
      transform: translateX(-400px);
    }

    .sidebar-header {
      padding: 28px 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-header h2 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .sidebar-header p {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .sidebar-search {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-search input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(40, 45, 58, 0.7);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      outline: none;
      transition: all 0.3s ease;
    }

    .sidebar-search input:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .sidebar-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-tab {
      flex: 1;
      padding: 16px;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .sidebar-tab:hover {
      background: rgba(52, 152, 219, 0.05);
      color: var(--accent-blue-light);
    }

    .sidebar-tab.active {
      color: var(--accent-blue-light);
      border-bottom: 2px solid var(--accent-blue);
      background: rgba(52, 152, 219, 0.1);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
    }

    .category-content {
      display: none;
    }

    .category-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .apps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
    }

    .app-card {
      background: rgba(40, 45, 58, 0.7);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      text-align: center;
    }

    .app-card:hover {
      background: rgba(52, 152, 219, 0.15);
      border-color: rgba(52, 152, 219, 0.4);
      transform: translateY(-4px);
      box-shadow: 0 8px 30px rgba(52, 152, 219, 0.2);
    }

    .app-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-dark));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .app-info h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .app-info p {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    /* Overlay for sidebar */
    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(5px);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .sidebar-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    /* Tab System */
    .tab-system {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 52px;
      background: rgba(15, 17, 23, 0.95);
      backdrop-filter: blur(28px);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      padding: 0 24px;
      z-index: 900;
      overflow: hidden;
      white-space: nowrap;
      scrollbar-width: none;
      -ms-overflow-style: none;
      justify-content: space-between;
      gap: 14px;
    }

    .tab-system::-webkit-scrollbar {
      display: none;
    }

    .tabs-container {
      display: flex;
      align-items: center;
      height: 100%;
      gap: 2px;
      flex: 1;
      min-width: 0;
      overflow-x: auto;
    }

    .tab {
      height: 32px;
      min-width: 120px;
      max-width: 200px;
      background: rgba(40, 45, 58, 0.5);
      border: 1px solid rgba(52, 152, 219, 0.1);
      border-radius: 6px 6px 0 0;
      padding: 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 12px;
      color: var(--text-secondary);
      position: relative;
      flex-shrink: 0;
    }

    .tab:hover {
      background: rgba(52, 152, 219, 0.1);
      border-color: rgba(52, 152, 219, 0.2);
    }

    .tab.active {
      background: rgba(52, 152, 219, 0.15);
      border-color: rgba(52, 152, 219, 0.3);
      color: var(--accent-blue-light);
      border-bottom: none;
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 1px;
      background: var(--bg-primary);
    }

    .tab-icon {
      width: 14px;
      height: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.8;
    }

    .tab-title {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .tab-close {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.5;
      transition: all 0.2s ease;
    }

    .tab-close:hover {
      background: rgba(255, 255, 255, 0.1);
      opacity: 1;
    }

    .new-tab {
      width: 32px;
      height: 32px;
      min-width: 32px;
      background: rgba(52, 152, 219, 0.1);
      border: 1px solid rgba(52, 152, 219, 0.2);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--accent-blue-light);
      margin-left: 5px;
    }

    .new-tab:hover {
      background: rgba(52, 152, 219, 0.2);
      transform: scale(1.05);
    }

    .tab-actions {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 10px;
      flex-shrink: 0;
      min-width: auto;
    }

    .menu-button {
      width: 46px;
      height: 38px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      background: rgba(13, 16, 24, 0.85);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      padding: 6px 4px;
    }

    .menu-button span {
      width: 24px;
      height: 2px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 2px;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .menu-button.active span:nth-child(1) {
      transform: rotate(45deg) translate(2px, 3px);
    }

    .menu-button.active span:nth-child(2) {
      opacity: 0;
    }

    .menu-button.active span:nth-child(3) {
      transform: rotate(-45deg) translate(2px, -3px);
    }

    /* Main Content - Homepage */
    .main-content {
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px 20px;
      text-align: center;
      position: relative;
      z-index: 1;
    }

    .hero-title {
      font-size: clamp(3.5rem, 10vw, 5rem);
      font-weight: 800;
      color: white;
      margin-bottom: 8px;
      line-height: 1;
      text-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .hero-title .version {
      font-size: clamp(1.5rem, 4vw, 2rem);
      font-weight: 300;
      color: var(--accent-blue-light);
      margin-left: 10px;
    }

    .hero-subtitle {
      font-size: clamp(1rem, 3vw, 1.2rem);
      font-weight: 400;
      color: var(--text-secondary);
      margin-bottom: 40px;
      letter-spacing: 0.5px;
    }

    /* Search Container */
    .search-container {
      width: 100%;
      max-width: 700px;
      margin: 0 auto;
    }

    .search-wrapper {
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 18px 24px 18px 56px;
      background: rgba(40, 45, 58, 0.7);
      border: 2px solid rgba(52, 152, 219, 0.3);
      border-radius: var(--radius);
      color: var(--text-primary);
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(10px);
    }

    .search-input:focus {
      border-color: var(--accent-blue);
      box-shadow: 0 8px 40px rgba(52, 152, 219, 0.3);
      transform: translateY(-2px);
    }

    .search-icon {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--accent-blue);
      font-size: 20px;
    }

    .search-hint {
      margin-top: 16px;
      font-size: 14px;
      color: var(--text-secondary);
      opacity: 0.8;
    }

    /* Browser Windows */
    .browser-windows {
      position: absolute;
      top: 52px;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10;
      display: none;
    }

    .browser-windows.active {
      display: block;
    }

    .browser-window {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      background: var(--bg-primary);
    }

    .browser-window.active {
      display: flex;
    }

    .window-content {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    .window-content iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    .window-loading {
      position: absolute;
      inset: 0;
      background: var(--bg-primary);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      z-index: 5;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(52, 152, 219, 0.2);
      border-top-color: var(--accent-blue);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Search Suggestions */
    .search-suggestions {
      position: absolute;
      top: calc(100% + 10px);
      left: 0;
      right: 0;
      background: rgba(30, 35, 48, 0.95);
      border: 1px solid rgba(52, 152, 219, 0.3);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: none;
      z-index: 1001;
      max-height: 400px;
      overflow-y: auto;
      backdrop-filter: blur(20px);
    }

    .suggestion-item {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-bottom: 1px solid rgba(52, 152, 219, 0.1);
    }

    .suggestion-item:hover {
      background: rgba(52, 152, 219, 0.15);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .apps-sidebar {
        width: 320px;
        right: -320px;
      }

      .apps-sidebar.active {
        transform: translateX(-320px);
      }

      .apps-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }

      .hero-title {
        font-size: clamp(2.5rem, 8vw, 4rem);
      }

      .search-container {
        padding: 0 20px;
      }

      .tab {
        min-width: 100px;
        max-width: 150px;
      }

    }

    @media (max-width: 480px) {
      .apps-sidebar {
        width: 280px;
        right: -280px;
      }

      .apps-sidebar.active {
        transform: translateX(-280px);
      }

      .apps-grid {
        grid-template-columns: 1fr;
      }

      .hero-title {
        font-size: 2.5rem;
      }

      .hero-title .version {
        font-size: 1.2rem;
      }

      .search-input {
        padding: 14px 20px 14px 48px;
      }

      .search-icon {
        left: 16px;
      }

      .tab {
        min-width: 80px;
        max-width: 120px;
        padding: 0 8px;
      }

      .tab-title {
        font-size: 11px;
      }

      .sidebar-header {
        padding: 24px 20px;
      }

      .sidebar-header h2 {
        font-size: 20px;
      }

      .sidebar-content {
        padding: 20px;
      }

    }

    @media (max-height: 700px) {
      .hero-title {
        margin-bottom: 4px;
      }

      .hero-subtitle {
        margin-bottom: 30px;
      }

      .sidebar-header {
        padding: 20px;
      }

      .sidebar-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Background Animation -->
  <div class="background-animation"></div>
  <div class="particles" id="particles"></div>

  <!-- Apps Sidebar -->
  <div class="apps-sidebar" id="appsSidebar">
    <div class="sidebar-header">
      <h2>Nebulo Apps</h2>
      <p>All your applications and games in one place</p>
    </div>
    
    <div class="sidebar-search">
      <input type="text" id="sidebarSearch" placeholder="Search apps and games..." />
    </div>
    
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" data-category="apps">
        <i class="fas fa-th-large"></i>
        <span>Apps</span>
      </button>
      <button class="sidebar-tab" data-category="games">
        <i class="fas fa-gamepad"></i>
        <span>Games</span>
      </button>
    </div>
    
    <div class="sidebar-content">
      <!-- Apps Category -->
      <div class="category-content active" id="appsContent">
        <div class="apps-grid" id="appsGrid">
          <!-- Apps will be dynamically added here -->
        </div>
      </div>
      
      <!-- Games Category -->
      <div class="category-content" id="gamesContent">
        <div class="apps-grid" id="gamesGrid">
          <!-- Games will be dynamically added here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <!-- Tab System -->
  <div class="tab-system" id="tabSystem">
    <div class="tabs-container" id="tabsContainer">
      <!-- Tabs will be added here dynamically -->
    </div>
    <div class="tab-actions">
      <div class="new-tab" id="newTab">
        <i class="fas fa-plus"></i>
      </div>
      <button class="menu-button" id="menuButton" aria-label="Open app sidebar">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
  </div>

  <!-- Main Content - Homepage -->
  <main class="main-content" id="mainContent">
    <h1 class="hero-title">
      Nebulo<span class="version">V5.4</span>
    </h1>
    <div class="hero-subtitle">Educational Algebra Practice & Advanced Math Tools</div>
    
    <div class="search-container">
      <div class="search-wrapper">
        <input type="text" class="search-input" id="searchInput" placeholder="Search or enter URL..." />
        <i class="fas fa-search search-icon"></i>
        <div class="search-suggestions" id="searchSuggestions"></div>
      </div>
      <div class="search-hint">
        <i class="fas fa-lightbulb"></i> Press Enter to search, or type a URL to browse
      </div>
    </div>
  </main>

  <!-- Browser Windows Container -->
  <div class="browser-windows" id="browserWindows">
    <!-- Browser windows will be added here -->
  </div>

  <!-- Main Application Script -->
  <script>
    // ======================
    // NEBULO OS V5.4
    // Fixed Version: All external URLs go through proxy
    // ======================
    
    const VERSION = "V5.4";
    
    // Main apps - ALL external URLs will be proxied
    const apps = [
      { id:'browser', name:'Browser', url:'/test', icon:'fa-globe', desc:'Browse the web', category: 'apps', proxied: true },
      { id:'music', name:'Music', url:'https://vapor.onl/page/music/index.html', icon:'fa-headphones', desc:'Listen & chill', category: 'apps', proxied: true },
      { id:'movies', name:'Movies', url:'https://www.cineby.gd', icon:'fa-film', desc:'Watch something', category: 'apps', proxied: true },
      { id:'chat', name:'Global Chat', url:'https://tlk.io/nebulo', icon:'fa-comments', desc:'Talk with others', category: 'apps', proxied: true },
      { id:'links', name:'Links', url:'/links', icon:'fa-link', desc:'Useful shortcuts', category: 'apps', proxied: true },
      { id:'settings', name:'Settings', url:'/settings', icon:'fa-cog', desc:'System settings', category: 'apps', proxied: true },
      { id:'help', name:'Help', url:'/help', icon:'fa-circle-question', desc:'Get help', category: 'apps', proxied: true },
      { id:'whatsnew', name:"What's New", url:'/whatsnew', icon:'fa-star', desc:'Updates & notes', category: 'apps', proxied: true },
      { id:'achievements', name:'Achievements', url:'/achievements', icon:'fa-trophy', desc:'Track progress', category: 'apps', proxied: true },
      { id:'something-not-working', name:'Report Issue', url:'https://forms.gle/GbmQTfsa8ta8oV8n8', icon:'fa-exclamation-triangle', desc:'Report an issue', category: 'apps', proxied: true },
      { id:'tiktok', name:'TikTok', url:'https://www.tiktok.com/', icon:'fa-music', desc:'Short videos', category: 'apps', proxied: true },
      { id:'youtube', name:'YouTube', url:'https://www.youtube.com/', icon:'fa-play-circle', desc:'Watch videos', category: 'apps', proxied: true },
      { id:'discord', name:'Discord', url:'https://discord.com/app', icon:'fa-comment-dots', desc:'Voice & text chat', category: 'apps', proxied: true },
      { id:'facebook', name:'Facebook', url:'https://www.facebook.com/', icon:'fa-facebook', desc:'Social network', category: 'apps', proxied: true },
      { id:'instagram', name:'Instagram', url:'https://www.instagram.com/', icon:'fa-instagram', desc:'Photo sharing', category: 'apps', proxied: true },
      { id:'twitter', name:'Twitter', url:'https://twitter.com/', icon:'fa-twitter', desc:'Microblogging', category: 'apps', proxied: true },
    ];
    
    // Games - ALL external URLs will be proxied
    const games = [
      { id:'roblox', name:'Roblox', url:'https://astra.pxi-fusion.com/embed/roblox?web-socket-enabled=false', icon:'fa-cube', desc:'Launch Roblox', category: 'games', proxied: true, forceProxy: 'uv' },
      { id:'clash-royale', name:'Clash Royale', url:'https://astra.pxi-fusion.com/embed/clash-royale?web-socket-enabled=false', icon:'fa-crown', desc:'Quick matches', category: 'games', proxied: true, forceProxy: 'uv' },
      { id:'minecraft', name:'Minecraft', url:'https://eaglercraft1-8.github.io/', icon:'fa-mountain', desc:'Build a world', category: 'games', proxied: true },
      { id:'crazygames', name:'CrazyGames', url:'https://www.crazygames.com/', icon:'fa-dice', desc:'Arcade games', category: 'games', proxied: true },
      { id:'gn-math', name:'GN Math', url:'https://gn-math.dev/', icon:'fa-calculator', desc:'Math practice', category: 'games', proxied: true },
      { id:'nowgg', name:'Now.gg', url:'https://nowgg.fun/', icon:'fa-cloud', desc:'Cloud gaming', category: 'games', proxied: true },
      { id:'blooket-bot', name:'Blooket Bot', url:'https://blooketbot.schoolcheats.net/', icon:'fa-robot', desc:'Open the bot tool', category: 'games', proxied: true },
      { id:'geforce-now', name:'GeForce Now', url:'https://play.geforcenow.com', icon:'fa-gamepad', desc:'Play games', category: 'games', proxied: true },
      { id:'xbox-cloud', name:'Xbox Cloud', url:'https://www.xbox.com/en-us/play', icon:'fa-xbox', desc:'Cloud gaming', category: 'games', proxied: true },
    ];
    
    // Global state
    const state = (window.state = {
      tabs: [],
      activeTabId: null,
      tabCounter: 0,
      sidebarOpen: false
    });
    
    // Initialize
    function init() {
      // Create particles
      createParticles();
      
      // Build sidebar apps and games
      buildSidebar();
      
      // Initialize search
      initSearch();
      
      // Set up event listeners
      setupEventListeners();
      
      // Create initial homepage tab
      createInitialTab();
    }
    
    // Create initial homepage tab
    function createInitialTab() {
      const homeTabId = createNewTab(null, null, "Home");
      createNewTabPage(homeTabId);
    }
    
    // Create background particles
    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      const particleCount = 30;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        
        // Random position
        const left = Math.random() * 100;
        const top = Math.random() * 100;
        particle.style.left = `${left}%`;
        particle.style.top = `${top}%`;
        
        // Random size
        const size = 1 + Math.random() * 3;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        
        // Random animation
        const duration = 15 + Math.random() * 25;
        const delay = Math.random() * 20;
        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${delay}s`;
        
        particlesContainer.appendChild(particle);
      }
    }
    
    // Build sidebar apps and games
    function buildSidebar() {
      // Build apps grid
      const appsGrid = document.getElementById('appsGrid');
      appsGrid.innerHTML = '';
      
      apps.forEach(app => {
        const card = createAppCard(app);
        appsGrid.appendChild(card);
      });
      
      // Build games grid
      const gamesGrid = document.getElementById('gamesGrid');
      gamesGrid.innerHTML = '';
      
      games.forEach(game => {
        const card = createAppCard(game);
        gamesGrid.appendChild(card);
      });
    }
    
    // Create app card for sidebar
    function createAppCard(app) {
      const card = document.createElement('div');
      card.className = 'app-card';
      card.dataset.appId = app.id;
      card.dataset.category = app.category;
      
      card.innerHTML = `
        <div class="app-icon">
          <i class="fa${app.icon.includes('fab') ? 'b' : 's'} ${app.icon}"></i>
        </div>
        <div class="app-info">
          <h4>${escapeHtml(app.name)}</h4>
          <p>${escapeHtml(app.desc)}</p>
        </div>
      `;
      
      card.addEventListener('click', async (e) => {
        e.stopPropagation();
        await openApp(app);
        closeSidebar();
      });
      
      return card;
    }
    
    // Sidebar Functions
    function openSidebar() {
      state.sidebarOpen = true;
      document.getElementById('appsSidebar').classList.add('active');
      document.getElementById('sidebarOverlay').classList.add('active');
      document.getElementById('menuButton').classList.add('active');
      
      // Focus search input
      setTimeout(() => {
        document.getElementById('sidebarSearch').focus();
      }, 300);
    }
    
    function closeSidebar() {
      state.sidebarOpen = false;
      document.getElementById('appsSidebar').classList.remove('active');
      document.getElementById('sidebarOverlay').classList.remove('active');
      document.getElementById('menuButton').classList.remove('active');
      
      // Clear search
      document.getElementById('sidebarSearch').value = '';
      filterSidebar('');
    }
    
    function toggleSidebar() {
      if (state.sidebarOpen) {
        closeSidebar();
      } else {
        openSidebar();
      }
    }
    
    function switchCategory(category) {
      // Update active tab
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.category === category) {
          tab.classList.add('active');
        }
      });
      
      // Show active content
      document.querySelectorAll('.category-content').forEach(content => {
        content.classList.remove('active');
        if (content.id === `${category}Content`) {
          content.classList.add('active');
        }
      });
    }
    
    function filterSidebar(query) {
      const searchTerm = query.toLowerCase().trim();
      
      // Filter apps
      document.querySelectorAll('#appsGrid .app-card').forEach(card => {
        const appId = card.dataset.appId;
        const app = apps.find(a => a.id === appId);
        if (!app) return;
        
        const matches = searchTerm === '' || 
          app.name.toLowerCase().includes(searchTerm) || 
          app.desc.toLowerCase().includes(searchTerm);
        
        card.style.display = matches ? 'flex' : 'none';
      });
      
      // Filter games
      document.querySelectorAll('#gamesGrid .app-card').forEach(card => {
        const appId = card.dataset.appId;
        const app = games.find(a => a.id === appId);
        if (!app) return;
        
        const matches = searchTerm === '' || 
          app.name.toLowerCase().includes(searchTerm) || 
          app.desc.toLowerCase().includes(searchTerm);
        
        card.style.display = matches ? 'flex' : 'none';
      });
    }
    
    // Tab System Functions
    function createNewTab(app = null, url = null, title = "New Tab") {
      state.tabCounter++;
      const tabId = `tab-${state.tabCounter}`;
      
      const tab = {
        id: tabId,
        app: app,
        url: url || (app ? app.url : null),
        title: title,
        icon: app ? app.icon : 'fa-globe',
        loading: false,
        active: false,
        error: false
      };
      
      const activeIndex = state.tabs.findIndex(t => t.active);
      const insertIndex = activeIndex >= 0 ? activeIndex + 1 : state.tabs.length;
      state.tabs.splice(insertIndex, 0, tab);
      
      // Show tab system
      document.getElementById('tabSystem').classList.add('active');
      
      // Create tab element
      createTabElement(tab, insertIndex);
     
      // Create browser window
      createBrowserWindow(tab);
      
      // Activate this tab
      activateTab(tabId);
      
      // Show browser windows container
      document.getElementById('browserWindows').classList.add('active');
      
      // Hide main content
      document.getElementById('mainContent').style.display = 'none';
      
      return tabId;
    }
    
    function createTabElement(tab, insertIndex = state.tabs.length - 1) {
      const tabsContainer = document.getElementById('tabsContainer');
      const tabEl = document.createElement('div');
      tabEl.className = 'tab';
      tabEl.id = `tab-el-${tab.id}`;
      tabEl.dataset.tabId = tab.id;
      
      tabEl.innerHTML = `
        <div class="tab-icon">
          <i class="fa${tab.icon.includes('fab') ? 'b' : 's'} ${tab.icon}"></i>
        </div>
        <div class="tab-title">${escapeHtml(tab.title)}</div>
        <div class="tab-close">
          <i class="fas fa-times"></i>
        </div>
      `;
      
      // Click to activate tab
      tabEl.addEventListener('click', (e) => {
        if (!e.target.closest('.tab-close')) {
          activateTab(tab.id);
        }
      });
      
      // Close tab
      const closeBtn = tabEl.querySelector('.tab-close');
      closeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        closeTab(tab.id);
      });
      
      const referenceEl = tabsContainer.children[insertIndex - 1];
      if (referenceEl && referenceEl.id !== tabEl.id) {
        if (referenceEl.nextSibling) {
          tabsContainer.insertBefore(tabEl, referenceEl.nextSibling);
        } else {
          tabsContainer.appendChild(tabEl);
        }
      } else {
        tabsContainer.appendChild(tabEl);
      }
    }
    
    function createBrowserWindow(tab) {
      const windowsContainer = document.getElementById('browserWindows');
      const windowEl = document.createElement('div');
      windowEl.className = 'browser-window';
      windowEl.id = `window-${tab.id}`;
      
      windowEl.innerHTML = `
        <div class="window-content">
          <div class="window-loading" id="loading-${tab.id}">
            <div class="loading-spinner"></div>
            <div>Loading ${escapeHtml(tab.title)}...</div>
          </div>
          <iframe src="about:blank" id="iframe-${tab.id}" sandbox="allow-same-origin allow-scripts allow-popups allow-forms allow-modals allow-orientation-lock allow-pointer-lock allow-presentation allow-top-navigation"></iframe>
        </div>
      `;
      
      windowsContainer.appendChild(windowEl);
      
      // Load content if URL is available
      if (tab.url) {
        loadTabContent(tab.id, tab.url, tab.app);
      }
    }
    
    async function loadTabContent(tabId, url, app = null) {
      const tab = state.tabs.find(t => t.id === tabId);
      if (!tab) return;
      
      tab.loading = true;
      tab.error = false;
      const iframe = document.getElementById(`iframe-${tabId}`);
      const loading = document.getElementById(`loading-${tabId}`);
      
      try {
        let finalUrl = url;
        
        // Check if it's a local path
        if (url && (url.startsWith('/') || url === '' || url === null)) {
          // For local paths or new tabs, create new tab page
          createNewTabPage(tabId);
          return;
        }
        
        // For ALL external URLs, use the proxy
        if (url && (url.startsWith('http://') || url.startsWith('https://'))) {
          // Use the proxy for this URL - ALWAYS use proxy for external URLs
          finalUrl = await encodeWithProxy(url, app?.forceProxy);
        }
        // If it's a domain-like string (google.com, youtube.com), add https:// and proxy it
        else if (url && url.includes('.') && !url.includes(' ') && !url.startsWith('/')) {
          const fullUrl = 'https://' + url;
          finalUrl = await encodeWithProxy(fullUrl);
        }
        else if (url) {
          // If we have a URL but it doesn't match above patterns, still try to proxy it
          finalUrl = await encodeWithProxy(url);
        }
        
        // Set iframe source
        iframe.src = finalUrl;
        
        // Set a timeout for loading
        const loadTimeout = setTimeout(() => {
          if (tab.loading) {
            handleTabError(tabId, 'Loading timeout. The site may be slow or blocked.');
          }
        }, 15000); // 15 second timeout
        
        iframe.onload = () => {
          clearTimeout(loadTimeout);
          tab.loading = false;
          if (loading) loading.style.display = 'none';
          
          // Try to get title from iframe
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            const iframeTitle = iframeDoc.title;
            if (iframeTitle && iframeTitle !== '') {
              updateTabTitle(tabId, iframeTitle);
            }
          } catch (e) {
            // Cross-origin error, ignore
          }
        };
        
        iframe.onerror = () => {
          clearTimeout(loadTimeout);
          handleTabError(tabId, 'Failed to load page. The site may be blocked or unavailable.');
        };
      } catch (error) {
        console.error('Failed to load tab content:', error);
        handleTabError(tabId, 'Proxy error. Please try a different site.');
      }
    }
    
    // Create a new tab page (homepage in tab)
    function createNewTabPage(tabId) {
      const tab = state.tabs.find(t => t.id === tabId);
      if (!tab) return;
      
      const iframe = document.getElementById(`iframe-${tabId}`);
      const loading = document.getElementById(`loading-${tabId}`);
      
      if (!iframe) return;
      
      // Create a simple new tab page with search functionality
      const newTabHTML = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Nebulo Home</title>
          <style>
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            
            body {
              font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              background: #0f1117;
              color: white;
              height: 100vh;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              padding: 20px;
              text-align: center;
            }
            
            .newtab-content {
              max-width: 700px;
              width: 100%;
            }
            
            .newtab-title {
              font-size: clamp(2.5rem, 8vw, 4rem);
              font-weight: 800;
              margin-bottom: 8px;
              line-height: 1;
              color: white;
            }
            
            .newtab-title .version {
              font-size: clamp(1.2rem, 3vw, 1.5rem);
              font-weight: 300;
              color: #5dade2;
              margin-left: 8px;
            }
            
            .newtab-subtitle {
              font-size: clamp(0.9rem, 2.5vw, 1.1rem);
              font-weight: 400;
              color: #b0b7c7;
              margin-bottom: 40px;
              letter-spacing: 0.5px;
            }
            
            .newtab-search-container {
              width: 100%;
              margin: 0 auto;
            }
            
            .newtab-search-wrapper {
              position: relative;
            }
            
            .newtab-search-input {
              width: 100%;
              padding: 18px 24px 18px 56px;
              background: rgba(40, 45, 58, 0.7);
              border: 2px solid rgba(52, 152, 219, 0.3);
              border-radius: 12px;
              color: white;
              font-size: 16px;
              outline: none;
              transition: all 0.3s ease;
            }
            
            .newtab-search-input:focus {
              border-color: #3498db;
              box-shadow: 0 8px 40px rgba(52, 152, 219, 0.3);
            }
            
            .newtab-search-icon {
              position: absolute;
              left: 20px;
              top: 50%;
              transform: translateY(-50%);
              color: #3498db;
              font-size: 20px;
            }
            
            .newtab-search-hint {
              margin-top: 16px;
              font-size: 14px;
              color: #b0b7c7;
              opacity: 0.8;
            }
            
            .newtab-quick-links {
              margin-top: 40px;
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
              gap: 16px;
            }
            
            .newtab-link {
              background: rgba(40, 45, 58, 0.7);
              border: 1px solid rgba(100, 120, 160, 0.2);
              border-radius: 12px;
              padding: 20px;
              cursor: pointer;
              transition: all 0.3s ease;
              display: flex;
              flex-direction: column;
              align-items: center;
              gap: 12px;
              text-align: center;
            }
            
            .newtab-link:hover {
              background: rgba(52, 152, 219, 0.15);
              border-color: rgba(52, 152, 219, 0.4);
              transform: translateY(-4px);
            }
            
            .newtab-link-icon {
              width: 48px;
              height: 48px;
              background: linear-gradient(135deg, #3498db, #1c6ea4);
              border-radius: 12px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 20px;
            }
            
            .newtab-link-title {
              font-size: 14px;
              font-weight: 600;
              color: white;
            }
          </style>
        </head>
        <body>
          <div class="newtab-content">
            <h1 class="newtab-title">
              Nebulo<span class="version">V5.4</span>
            </h1>
            <div class="newtab-subtitle">Start browsing or search the web</div>
            
            <div class="newtab-search-container">
              <div class="newtab-search-wrapper">
                <input type="text" class="newtab-search-input" id="newtabSearchInput" placeholder="Search or enter URL..." />
                <div class="newtab-search-icon">üîç</div>
              </div>
              <div class="newtab-search-hint">
                Press Enter to search, or type a URL to browse
              </div>
            </div>
            
            <div class="newtab-quick-links">
              <div class="newtab-link" data-url="https://www.google.com">
                <div class="newtab-link-icon">G</div>
                <div class="newtab-link-title">Google</div>
              </div>
              <div class="newtab-link" data-url="https://www.youtube.com">
                <div class="newtab-link-icon">YT</div>
                <div class="newtab-link-title">YouTube</div>
              </div>
              <div class="newtab-link" data-url="https://github.com">
                <div class="newtab-link-icon">GH</div>
                <div class="newtab-link-title">GitHub</div>
              </div>
              <div class="newtab-link" data-url="https://www.wikipedia.org">
                <div class="newtab-link-icon">W</div>
                <div class="newtab-link-title">Wikipedia</div>
              </div>
            </div>
          </div>
          
          <script>
            // Search functionality for new tab page
            const searchInput = document.getElementById('newtabSearchInput');
            
            searchInput.addEventListener('keydown', function(e) {
              if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                  window.parent.postMessage({
                    type: 'newtab-search',
                    query: query
                  }, '*');
                }
              }
            });
            
            // Quick links
            document.querySelectorAll('.newtab-link').forEach(link => {
              link.addEventListener('click', function() {
                const url = this.dataset.url;
                window.parent.postMessage({
                  type: 'newtab-navigate',
                  url: url
                }, '*');
              });
            });
            
            // Focus search input on load
            searchInput.focus();
          <\/script>
        </body>
        </html>
      `;
      
      // Write the HTML to the iframe
      iframe.onload = function() {
        const iframeDoc = iframe.contentDocument;
        iframeDoc.open();
        iframeDoc.write(newTabHTML);
        iframeDoc.close();
        
        // Hide loading indicator
        if (loading) {
          loading.style.display = 'none';
        }
        
        tab.loading = false;
      };
      
      // Set the iframe source to about:blank first
      iframe.src = 'about:blank';
    }
    
    function handleTabError(tabId, message) {
      const tab = state.tabs.find(t => t.id === tabId);
      if (!tab) return;
      
      tab.loading = false;
      tab.error = true;
      const loading = document.getElementById(`loading-${tabId}`);
      
      if (loading) {
        loading.innerHTML = `
          <div style="text-align: center; padding: 20px; max-width: 400px;">
            <div class="loading-spinner" style="border-color: #e74c3c; border-top-color: #c0392b;"></div>
            <div style="margin-top: 20px; color: #e74c3c; font-weight: 600;">Error Loading Page</div>
            <div style="margin-top: 10px; color: #b0b7c7; font-size: 14px; line-height: 1.4;">${escapeHtml(message)}</div>
            <div style="margin-top: 20px;">
              <button class="retry-btn" style="padding: 10px 20px; background: rgba(52, 152, 219, 0.2); border: 1px solid rgba(52, 152, 219, 0.3); border-radius: 6px; color: var(--accent-blue-light); cursor: pointer; font-size: 14px;">Retry Loading</button>
            </div>
          </div>
        `;
        
        // Add retry button event
        const retryBtn = loading.querySelector('.retry-btn');
        if (retryBtn) {
          retryBtn.addEventListener('click', () => {
            loadTabContent(tabId, tab.url, tab.app);
          });
        }
      }
    }
    
    function activateTab(tabId) {
      // Deactivate all tabs
      state.tabs.forEach(tab => {
        tab.active = false;
        const tabEl = document.getElementById(`tab-el-${tab.id}`);
        const windowEl = document.getElementById(`window-${tab.id}`);
        
        if (tabEl) tabEl.classList.remove('active');
        if (windowEl) windowEl.classList.remove('active');
      });
      
      // Activate selected tab
      const tab = state.tabs.find(t => t.id === tabId);
      if (tab) {
        tab.active = true;
        state.activeTabId = tabId;
        
        const tabEl = document.getElementById(`tab-el-${tab.id}`);
        const windowEl = document.getElementById(`window-${tab.id}`);
        
        if (tabEl) tabEl.classList.add('active');
        if (windowEl) windowEl.classList.add('active');
        
        // Ensure tab is visible in tab system
        if (tabEl) {
          tabEl.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
      }
    }
    
    function updateTabTitle(tabId, title) {
      const tab = state.tabs.find(t => t.id === tabId);
      if (!tab) return;
      
      tab.title = title;
      const tabEl = document.getElementById(`tab-el-${tabId}`);
      if (tabEl) {
        const titleEl = tabEl.querySelector('.tab-title');
        if (titleEl) {
          titleEl.textContent = escapeHtml(title);
        }
      }
    }
    
    function closeTab(tabId) {
      const tabIndex = state.tabs.findIndex(t => t.id === tabId);
      if (tabIndex === -1) return;
      
      // Remove tab element
      const tabEl = document.getElementById(`tab-el-${tabId}`);
      if (tabEl) tabEl.remove();
      
      // Remove browser window
      const windowEl = document.getElementById(`window-${tabId}`);
      if (windowEl) windowEl.remove();
      
      // Remove from state
      state.tabs.splice(tabIndex, 1);
      
      // Update active tab
      if (state.activeTabId === tabId) {
        if (state.tabs.length > 0) {
          // Activate the next tab, or the previous one if at the end
          const nextTabIndex = Math.min(tabIndex, state.tabs.length - 1);
          activateTab(state.tabs[nextTabIndex].id);
        } else {
          // No tabs left, show homepage
          state.activeTabId = null;
          document.getElementById('tabSystem').classList.remove('active');
          document.getElementById('browserWindows').classList.remove('active');
          document.getElementById('mainContent').style.display = 'flex';
        }
      }
    }
    
    // Event listeners
    function setupEventListeners() {
      // Hamburger menu button
      document.getElementById('menuButton').addEventListener('click', toggleSidebar);
      
      // Sidebar overlay (click to close)
      document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);
      
      // Sidebar category tabs
      document.querySelectorAll('.sidebar-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const category = tab.dataset.category;
          switchCategory(category);
        });
      });
      
      // Sidebar search
      const sidebarSearch = document.getElementById('sidebarSearch');
      sidebarSearch.addEventListener('input', () => {
        filterSidebar(sidebarSearch.value);
      });
      
      // New tab button
      document.getElementById('newTab').addEventListener('click', () => {
        createNewTab(null, null, "New Tab");
      });
      
      // Escape key closes sidebar
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && state.sidebarOpen) {
          closeSidebar();
        }
        
        // Ctrl/Cmd + T for new tab
        if ((e.ctrlKey || e.metaKey) && e.key === 't') {
          e.preventDefault();
          createNewTab(null, null, "New Tab");
        }
      });
      
      // Listen for messages from iframes (new tab page)
      window.addEventListener('message', function(event) {
        if (event.data.type === 'newtab-search') {
          // Load search in CURRENT active tab
          if (state.activeTabId) {
            const tab = state.tabs.find(t => t.id === state.activeTabId);
            if (tab) {
              // Update tab title and load search
              tab.title = `Search: ${event.data.query.substring(0, 20)}`;
              updateTabTitle(tab.id, tab.title);
              loadTabContent(tab.id, event.data.query);
            }
          }
        } else if (event.data.type === 'newtab-navigate') {
          // Navigate in CURRENT active tab
          if (state.activeTabId) {
            const tab = state.tabs.find(t => t.id === state.activeTabId);
            if (tab) {
              loadTabContent(tab.id, event.data.url);
            }
          }
        }
      });
    }
    
    // Open app in CURRENT active tab (not new tab)
    async function openApp(app) {
      if (app.id === 'something-not-working') {
        window.open(app.url, '_blank', 'noopener');
        return;
      }
      
      // If we have an active tab, load the app in that tab
      if (state.activeTabId) {
        const activeTab = state.tabs.find(t => t.id === state.activeTabId);
        if (activeTab) {
          // Update tab info
          activeTab.app = app;
          activeTab.url = app.url;
          activeTab.icon = app.icon;
          activeTab.title = app.name;
          
          // Update tab element
          const tabEl = document.getElementById(`tab-el-${state.activeTabId}`);
          if (tabEl) {
            const iconEl = tabEl.querySelector('.tab-icon i');
            const titleEl = tabEl.querySelector('.tab-title');
            if (iconEl) iconEl.className = `fa${app.icon.includes('fab') ? 'b' : 's'} ${app.icon}`;
            if (titleEl) titleEl.textContent = app.name;
          }
          
          // Load the app content in the current tab
          loadTabContent(state.activeTabId, app.url, app);
          closeSidebar();
          return;
        }
      }
      
      // If no active tab, create new tab
      createNewTab(app, app.url, app.name);
      closeSidebar();
    }
    
    // Proxy functions - IMPORTANT: ALL external URLs go through proxy
    const SEARCH_ENGINE_DEFAULT = "duckduckgo";
    
    function resolveSearchUrl(query) {
      if (query.startsWith('http://') || query.startsWith('https://')) {
        return query;
      } else if (query.includes('.') && !query.includes(' ')) {
        return 'https://' + query;
      }
      const engine = (localStorage.getItem('searchEngine') || SEARCH_ENGINE_DEFAULT).toLowerCase();
      switch (engine) {
        case 'brave':
          return `https://search.brave.com/search?q=${encodeURIComponent(query)}`;
        case 'google':
          return `https://www.google.com/search?q=${encodeURIComponent(query)}`;
        case 'duckduckgo':
          return `https://duckduckgo.com/?t=h_&q=${encodeURIComponent(query)}`;
        case 'bing':
          return `https://www.bing.com/search?q=${encodeURIComponent(query)}`;
        case 'yahoo':
          return `https://search.yahoo.com/search?p=${encodeURIComponent(query)}`;
        default:
          return `https://duckduckgo.com/?t=h_&q=${encodeURIComponent(query)}`;
      }
    }
    
    async function encodeWithProxy(url, proxyHint = null) {
      try {
        if (window.proxyEncoder) {
          return await window.proxyEncoder.encode(url, proxyHint);
        } else if (typeof __uv$config !== 'undefined') {
          return __uv$config.prefix + __uv$config.encodeUrl(url);
        } else if (typeof window.encodeProxiedUrl === "function") {
          return window.encodeProxiedUrl(url);
        }
      } catch(e) {
        console.error('Proxy encoding failed:', e);
      }
      return url;
    }
    
    async function resolveAppUrl(app) {
      const rawUrl = app.url;
      const external = /^https?:\/\//i.test(rawUrl);
      if (!external) return rawUrl;
      
      // ALWAYS proxy external URLs
      if (app.proxied || !rawUrl.includes(location.hostname)) {
        try {
          const proxyHint = app.forceProxy || null;
          return await encodeWithProxy(rawUrl, proxyHint);
        } catch (err) {
          console.error('Proxy encoding failed for', rawUrl, err);
        }
      }
      return rawUrl;
    }
    
    // Search functionality - USING PROXY FOR ALL SEARCHES
    function initSearch() {
      const input = document.getElementById('searchInput');
      const suggestions = document.getElementById('searchSuggestions');
      
      input.addEventListener('focus', () => {
        showSuggestions('');
      });
      
      input.addEventListener('input', () => {
        showSuggestions(input.value);
      });
      
      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          await performSearch(input.value);
        } else if (e.key === 'Escape') {
          suggestions.style.display = 'none';
        }
      });
      
      document.addEventListener('click', (e) => {
        if (!suggestions.contains(e.target) && e.target !== input) {
          suggestions.style.display = 'none';
        }
      });
    }
    
    function showSuggestions(query) {
      const suggestions = document.getElementById('searchSuggestions');
      const allItems = [...apps, ...games];
      const matches = query
        ? allItems.filter(item => item.name.toLowerCase().includes(query.toLowerCase())).slice(0, 8)
        : allItems.slice(0, 6);
      
      if (matches.length === 0 && query.trim() === '') {
        suggestions.style.display = 'none';
        return;
      }
      
      suggestions.innerHTML = matches.map(item => `
        <div class="suggestion-item" data-app-id="${item.id}">
          <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--accent-blue), var(--accent-blue-dark)); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
            <i class="fa${item.icon.includes('fab') ? 'b' : 's'} ${item.icon}"></i>
          </div>
          <div>
            <div>${escapeHtml(item.name)}</div>
            <div style="font-size: 12px; color: var(--text-secondary);">${escapeHtml(item.desc)}</div>
          </div>
        </div>
      `).join('');
      
      if (query.trim()) {
        suggestions.innerHTML += `
          <div class="suggestion-item" data-search="${escapeAttr(query)}">
            <div style="width: 32px; height: 32px; background: rgba(52, 152, 219, 0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--accent-blue);">
              <i class="fas fa-search"></i>
            </div>
            <div>
              <div>Search for "${escapeHtml(query)}"</div>
              <div style="font-size: 12px; color: var(--text-secondary);">Press Enter to search the web</div>
            </div>
          </div>
        `;
      }
      
      suggestions.style.display = 'block';
      
      suggestions.querySelectorAll('[data-app-id]').forEach(el => {
        el.addEventListener('click', async () => {
          const appId = el.dataset.appId;
          let app = apps.find(a => a.id === appId) || games.find(g => g.id === appId);
          if (app) {
            await openApp(app);
            suggestions.style.display = 'none';
            input.value = '';
          }
        });
      });
      
      const searchBtn = suggestions.querySelector('[data-search]');
      if (searchBtn) {
        searchBtn.addEventListener('click', async () => {
          await performSearch(searchBtn.dataset.search);
          suggestions.style.display = 'none';
        });
      }
    }
    
    async function performSearch(query) {
      const trimmed = query.trim();
      if (!trimmed) return;
      
      const url = resolveSearchUrl(trimmed);
      const encodedUrl = await encodeWithProxy(url);
      
      // If we have an active tab, load search in that tab
      if (state.activeTabId) {
        const activeTab = state.tabs.find(t => t.id === state.activeTabId);
        if (activeTab) {
          // Update tab info
          activeTab.app = {
            id: 'search-' + Date.now(),
            name: `Search: ${trimmed.substring(0, 20)}${trimmed.length > 20 ? '...' : ''}`,
            url: encodedUrl,
            icon: 'fa-search',
            desc: 'Search result',
            proxied: true
          };
          activeTab.url = encodedUrl;
          activeTab.icon = 'fa-search';
          activeTab.title = `Search: ${trimmed}`;
          
          // Update tab element
          const tabEl = document.getElementById(`tab-el-${state.activeTabId}`);
          if (tabEl) {
            const iconEl = tabEl.querySelector('.tab-icon i');
            const titleEl = tabEl.querySelector('.tab-title');
            if (iconEl) iconEl.className = `fas fa-search`;
            if (titleEl) titleEl.textContent = `Search: ${trimmed}`;
          }
          
          // Load the search in the current tab
          loadTabContent(state.activeTabId, encodedUrl, activeTab.app);
          document.getElementById('searchInput').value = '';
          document.getElementById('searchSuggestions').style.display = 'none';
          return;
        }
      }
      
      // If no active tab, create new tab
      const searchApp = {
        id: 'search-' + Date.now(),
        name: `Search: ${trimmed.substring(0, 20)}${trimmed.length > 20 ? '...' : ''}`,
        url: encodedUrl,
        icon: 'fa-search',
        desc: 'Search result',
        proxied: true
      };
      
      createNewTab(searchApp, encodedUrl, `Search: ${trimmed}`);
      document.getElementById('searchInput').value = '';
      document.getElementById('searchSuggestions').style.display = 'none';
    }
    
    // Utility functions
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }
    
    function escapeAttr(s) {
      return escapeHtml(s).replace(/"/g, '&quot;');
    }
    
    // Quick access function - ALWAYS uses proxy
    window.quick = async function(url) {
      let encodedUrl = url;
      try {
        encodedUrl = await encodeWithProxy(url);
      } catch(e) {
        console.error('Proxy encoding failed:', e);
      }
      
      const quickApp = {
        id: 'quick-' + Date.now(),
        name: 'Quick Access',
        url: encodedUrl,
        icon: 'fa-bolt',
        desc: 'Quick access tab',
        proxied: true
      };
      
      // Load in current active tab if exists
      if (state.activeTabId) {
        const activeTab = state.tabs.find(t => t.id === state.activeTabId);
        if (activeTab) {
          loadTabContent(state.activeTabId, encodedUrl, quickApp);
          return;
        }
      }
      
      createNewTab(quickApp, encodedUrl, 'Quick Access');
    };
    
    // Initialize on load
    window.addEventListener('load', init);
    
    // Global functions for external use
    window.openApp = openApp;
    window.performSearch = performSearch;
    
  </script>
</body>
</html>