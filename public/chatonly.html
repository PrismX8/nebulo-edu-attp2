<!doctype html>































































<html lang="en">































































<head>































































  <meta charset="utf-8" />































































  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Nebulo Education Plus is a math-focused experience offering educational algebra practice tests to strengthen advanced math skills.">
  <meta name="keywords" content="math, algebra, advanced math practice test, educational exercises, study tools">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Nebulo Education Plus - Educational Algebra Practice Tests">
  <meta property="og:description" content="Step into a dedicated math site built around educational algebra practice tests designed to enhance advanced math skills.">

<title>Global Chat (Ably)</title>































































































































  <link rel="stylesheet" href="https://unpkg.com/open-props/normalize.min.css">































































  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">































































































































  <style>































































    :root{































































      --bg:#0f172a;































































      --panel:#111827;































































      --panel2:#0b1220;































































      --stroke:rgba(255,255,255,.10);































































      --text:#f8fafc;































































      --muted:#94a3b8;































































      --accent:#7dd3c0;































































      --accent2:#5bb98c;































































      --danger:#ef4444;































































      --warn:#f59e0b;































































      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;































































      color-scheme: dark;































































    }































































    *{box-sizing:border-box}































































    body{































































      margin:0; height:100vh; overflow:hidden;































































      background: radial-gradient(1200px 600px at 20% 0%, rgba(125,211,192,.10), transparent 55%),































































                  radial-gradient(900px 500px at 80% 10%, rgba(59,130,246,.08), transparent 55%),































































                  var(--bg);































































      color:var(--text);































































      display:flex; flex-direction:column;































































    }































































    .header{































































      flex-shrink:0;































































      display:flex; align-items:center; justify-content:space-between;































































      padding:12px 14px;































































      background: rgba(17,24,39,.75);































































      border-bottom:1px solid var(--stroke);































































      backdrop-filter: blur(10px);































































    }































































    .title{































































      display:flex; align-items:center; gap:10px;































































      font-weight:700;































































    }































































    .pill{































































      font-size:.8rem;































































      padding:3px 8px;































































      border-radius:999px;































































      border:1px solid var(--stroke);































































      background: rgba(255,255,255,.04);































































      color:var(--muted);































































      user-select:none;































































    }































































    .pill.online{































































      color:var(--accent);































































      border-color: rgba(125,211,192,.25);































































      background: rgba(125,211,192,.10);































































      min-width: 70px;































































      text-align:center;































































    }































































    .status{































































      font-size:.85rem;































































      color:var(--muted);































































      display:flex; align-items:center; gap:8px;































































    }































































    .dot{































































      width:9px; height:9px; border-radius:50%;































































      background: var(--warn);































































      box-shadow: 0 0 0 3px rgba(245,158,11,.15);































































    }































































    .dot.ok{































































      background: var(--accent);































































      box-shadow: 0 0 0 3px rgba(125,211,192,.15);































































    }































































    .dot.bad{































































      background: var(--danger);































































      box-shadow: 0 0 0 3px rgba(239,68,68,.15);































































    }































































































































    .content{ flex:1; display:flex; min-height:0; background: rgba(11,18,32,.55); position:relative; }































































































































    .coming-soon-overlay{































































      position:fixed;































































      inset:0;































































      background:rgba(0,0,0,0.9);































































      z-index:9999;































































      display:flex;































































      align-items:center;































































      justify-content:center;































































      flex-direction:column;































































      gap:12px;































































      font-size:clamp(1.2rem,3vw,2rem);































































      text-align:center;































































    }































































    .coming-soon-overlay span{































































      color:#f87171;































































      font-weight:600;































































    }































































    .messages{































































      flex:1; min-height:0;































































      padding:14px;































































      overflow:auto;































































      display:flex;































































      flex-direction:column;































































      gap:10px;































































    }































































    .msg{































































      max-width: 78%;































































      padding:10px 12px;































































      border-radius:16px;































































      border:1px solid var(--stroke);































































      background: rgba(17,24,39,.65);































































      align-self:flex-start;































































    }































































    .msg.me{































































      background: linear-gradient(135deg, var(--accent), var(--accent2));































































      color:#0b1220;































































      border:none;































































      align-self:flex-end;































































    }































































    .meta{































































      display:flex; gap:8px; align-items:baseline;































































      margin-bottom:4px;































































      font-size:.8rem;































































      opacity:.95;































































      flex-wrap:wrap;































































    }































































    .name{font-weight:700}































































    .time{color:var(--muted)}































































    .msg.me .time{color: rgba(11,18,32,.65)}































































    .text{white-space:pre-wrap; word-break:break-word}































































































































    .system{































































      align-self:center;































































      max-width: 85%;































































      text-align:center;































































      color: var(--muted);































































      font-size:.85rem;































































      padding:8px 10px;































































      border-radius: 12px;































































      border: 1px solid var(--stroke);































































      background: rgba(255,255,255,.03);































































    }































































































































    .composer{































































      flex-shrink:0;































































      padding:12px 14px;































































      border-top:1px solid var(--stroke);































































      background: rgba(17,24,39,.80);































































      display:flex; gap:10px; align-items:flex-end;































































      backdrop-filter: blur(10px);































































    }































































    textarea{































































      flex:1;































































      min-height:44px; max-height:120px;































































      resize:none;































































      border-radius:12px;































































      border:1px solid var(--stroke);































































      background: rgba(11,18,32,.6);































































      padding:10px 12px;































































      color:var(--text);































































      outline:none;































































    }































































    textarea:focus{border-color: rgba(125,211,192,.55)}































































    button{































































      width:44px; height:44px;































































      border:none;































































      border-radius:12px;































































      cursor:pointer;































































      background: linear-gradient(135deg, var(--accent), var(--accent2));































































      color:#0b1220;































































      font-size:1rem;































































      display:flex; align-items:center; justify-content:center;































































      transition: transform .15s ease;































































    }































































    button:active{transform: translateY(1px)}































































    .typing{































































      position:absolute; left:14px; bottom:70px;































































      color:var(--muted); font-size:.85rem;































































      pointer-events:none;































































      opacity:0; transition: opacity .2s ease;































































    }































































    .typing.on{opacity:1}































































  </style>































































</head>































































<body>































































  <div class="coming-soon-overlay">































































    <span>Chat coming soon</span>































































    <div>We are polishing the experience—check back shortly.</div>































































  </div>































































  <div class="header">































































    <div class="title">































































      <i class="fa-solid fa-comments" style="color:var(--accent)"></i>































































      <span>Global Chat</span>































































      <span class="pill online" id="onlinePill">— online</span>































































    </div>































































    <div class="status">































































      <span class="dot" id="connDot"></span>































































      <span class="pill" id="connLabel">connecting…</span>































































      <span class="pill" id="mePill">me: —</span>































































    </div>































































  </div>































































































































  <div class="content">































































    <div class="messages" id="messages"></div>































































    <div class="typing" id="typing"></div>































































  </div>































































































































  <!--<div class="composer">































































    <textarea id="input" placeholder="Type a message…" maxlength="750"></textarea>































































    <button id="sendBtn" title="Send"><i class="fa-solid fa-paper-plane"></i></button>































































  </div>-->































































































































  <script src="https://cdn.ably.com/lib/ably.min-1.js"></script>































































































































  <script>































































    // ============================































































    // Ably-only Global Chat (fixed)































































    // - No double send/render































































    // - Restores history on reopen































































    // - Unread badge + parent hooks































































    // ============================































































































































    const ABLY_PUBLIC_KEY = "9Lp0gQ.SJMJRw:qSyA5dJHk5K81nP-1w5Lpl4xxk45isEbvlpZLq7UU48";































































    const CHAT_CHANNEL = "global-chat";































































    const CHAT_EVENT = "chat";































































    const TYPING_EVENT = "typing";































































































































    const MAX_LEN = 750;































































































































    // burst limiter (client-side)































































    const BURST_WINDOW_MS = 2000;































































    const BURST_MAX = 4;































































    const sentTimes = [];































































































































    // typing throttles































































    const TYPING_THROTTLE_MS = 2500;































































    const TYPING_DISPLAY_MS = 4000;































































































































    // session restore































































    const SS_KEY_MESSAGES = "ably_chat_cache_v1";































































    const SS_KEY_UNREAD = "ably_chat_unread_v1";































































































































    // username storage































































    const LS_USER = "ably_chat_username_v1";































































































































    // UI refs































































    const messagesEl = document.getElementById("messages");































































    const inputEl = document.getElementById("input");































































    const sendBtn = document.getElementById("sendBtn");































































    const onlinePill = document.getElementById("onlinePill");































































    const connDot = document.getElementById("connDot");































































    const connLabel = document.getElementById("connLabel");































































    const mePill = document.getElementById("mePill");































































    const typingEl = document.getElementById("typing");































































































































    // state































































    let isChatWindowOpen = true; // if parent says closed, we set false































































    let notificationsEnabled = true;































































    let unreadCount = Number(sessionStorage.getItem(SS_KEY_UNREAD) || "0") || 0;































































































































    const seenIds = new Set(); // dedupe by message id































































    const typingUsers = new Map();































































    let typingCleanupTimer = null;































































    let lastTypingSentAt = 0;































































































































    function sanitizeName(s){































































      s = String(s || "").trim().replace(/[\u0000-\u001F\u007F]/g, "");































































      return s.slice(0, 24);































































    }































































    function escapeHtml(str){































































      return String(str)































































        .replaceAll("&","&amp;")































































        .replaceAll("<","&lt;")































































        .replaceAll(">","&gt;")































































        .replaceAll('"',"&quot;")































































        .replaceAll("'","&#039;");































































    }































































    function timeLabel(ts){































































      const d = new Date(ts || Date.now());































































      return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});































































    }































































    function scrollToBottom(){































































      messagesEl.scrollTop = messagesEl.scrollHeight;































































    }































































    function addSystem(text){































































      const div = document.createElement("div");































































      div.className = "system";































































      div.textContent = text;































































      messagesEl.appendChild(div);































































      scrollToBottom();































































    }































































    function renderMessage({ id, name, text, ts }){































































      const isMe = name === username;































































      const wrap = document.createElement("div");































































      wrap.className = "msg" + (isMe ? " me" : "");































































      wrap.dataset.id = id;































































































































      wrap.innerHTML = `































































        <div class="meta">































































          <span class="name">${escapeHtml(name)}</span>































































          <span class="time">${escapeHtml(timeLabel(ts))}</span>































































        </div>































































        <div class="text">${escapeHtml(text)}</div>































































      `;































































































































      messagesEl.appendChild(wrap);































































      scrollToBottom();































































    }































































































































    function loadCachedMessages(){































































      try{































































        const raw = sessionStorage.getItem(SS_KEY_MESSAGES);































































        if (!raw) return;































































        const arr = JSON.parse(raw);































































        if (!Array.isArray(arr)) return;































































































































        for (const m of arr){































































          if (!m || !m.id) continue;































































          if (seenIds.has(m.id)) continue;































































          seenIds.add(m.id);































































          renderMessage(m);































































        }































































      }catch{}































































    }































































































































    function saveCachedMessages(){































































      // keep last ~120 messages in session cache































































      const nodes = Array.from(messagesEl.querySelectorAll(".msg"));































































      const last = nodes.slice(-120).map(n => {































































        const id = n.dataset.id || "";































































        const name = n.querySelector(".name")?.textContent || "Unknown";































































        const text = n.querySelector(".text")?.textContent || "";































































        // time label is formatted; we store Date.now approx not critical































































        return { id, name, text, ts: Date.now() };































































      });































































      try{ sessionStorage.setItem(SS_KEY_MESSAGES, JSON.stringify(last)); }catch{}































































    }































































































































    function updateUnreadBadge(){































































      try{































































        sessionStorage.setItem(SS_KEY_UNREAD, String(unreadCount));































































      }catch{}































































      try{































































        window.parent.postMessage({































































          type: "updateChatBadge",































































          count: unreadCount,































































          show: unreadCount > 0































































        }, "*");































































      }catch{}































































    }































































































































    function showChatNotification(name, text){































































      if (!notificationsEnabled) return;































































      try{































































        window.parent.postMessage({































































          type: "showChatNotification",































































          username: name,































































          content: text.length > 60 ? text.slice(0, 60) + "…" : text































































        }, "*");































































      }catch{}































































    }































































































































    function resetUnread(){































































      unreadCount = 0;































































      updateUnreadBadge();































































    }































































































































    function canSendNow(){































































      const now = Date.now();































































      while (sentTimes.length && sentTimes[0] < now - BURST_WINDOW_MS) sentTimes.shift();































































      if (sentTimes.length >= BURST_MAX) return false;































































      sentTimes.push(now);































































      return true;































































    }































































































































    function uuid(){































































      // fast unique enough for chat































































      return "m_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2, 9);































































    }































































































































    function refreshTyping(){































































      const names = Array.from(typingUsers.keys());































































      if (!names.length){































































        typingEl.classList.remove("on");































































        typingEl.textContent = "";































































        return;































































      }































































      typingEl.classList.add("on");































































      typingEl.textContent =































































        names.length === 1 ? `${names[0]} is typing…` : `${names[0]} and ${names.length - 1} others are typing…`;































































    }































































































































    function noteTyping(name){































































      if (!name || name === username) return;































































      typingUsers.set(name, Date.now());































































      refreshTyping();































































































































      clearTimeout(typingCleanupTimer);































































      typingCleanupTimer = setTimeout(() => {































































        const cutoff = Date.now() - TYPING_DISPLAY_MS;































































        for (const [k,v] of typingUsers.entries()){































































          if (v < cutoff) typingUsers.delete(k);































































        }































































        refreshTyping();































































      }, 250);































































    }































































































































    // Username resolution































































    const urlUser = (new URL(location.href)).searchParams.get("username");































































    const storedUser = localStorage.getItem(LS_USER);































































    const username = sanitizeName(urlUser || storedUser || ("User" + Math.floor(Math.random()*9000 + 1000)));































































    localStorage.setItem(LS_USER, username);































































    mePill.textContent = "me: " + username;































































































































    // Ably init































































    const realtime = new Ably.Realtime.Promise({































































      key: ABLY_PUBLIC_KEY,































































      clientId: username,































































      closeOnUnload: true































































    });































































































































    realtime.connection.on("connected", async () => {































































      connDot.className = "dot ok";































































      connLabel.textContent = "connected";































































      await loadHistory();































































    });































































    realtime.connection.on("connecting", () => {































































      connDot.className = "dot";































































      connLabel.textContent = "connecting…";































































    });































































    realtime.connection.on("disconnected", () => {































































      connDot.className = "dot";































































      connLabel.textContent = "disconnected";































































    });































































    realtime.connection.on("failed", (s) => {































































      connDot.className = "dot bad";































































      connLabel.textContent = "failed";































































      addSystem("Connection failed. Check your network and try again.");































































      console.warn("Ably failed:", s?.reason);































































    });































































































































    const channel = realtime.channels.get(CHAT_CHANNEL);































































































































    // Presence for online count































































    async function enterPresence(){































































      try{ await channel.presence.enter({ username }); }































































      catch(e){ console.warn("presence enter failed", e); }































































    }































































































































    async function updateOnlineCount(){































































      try{































































        const members = await channel.presence.get();































































        onlinePill.textContent = `${members.length} online`;































































      }catch{































































        onlinePill.textContent = `— online`;































































      }































































    }































































































































    channel.presence.subscribe(() => updateOnlineCount());































































































































    // Incoming chat messages (DEDUP + no double render)































































    channel.subscribe(CHAT_EVENT, (msg) => {































































      const d = msg?.data || {};































































      const id = String(d.id || "");































































      const name = sanitizeName(d.name || "Unknown");































































      const text = String(d.text || "").slice(0, MAX_LEN);































































      const ts = Number(d.ts || msg.timestamp || Date.now());































































































































      if (!id || !text) return;































































      if (seenIds.has(id)) return; // prevents duplicate renders































































      seenIds.add(id);































































































































      renderMessage({ id, name, text, ts });































































      saveCachedMessages();































































































































      // unread + notifications when chat is "closed"































































      if (name !== username && isChatWindowOpen === false){































































        unreadCount++;































































        updateUnreadBadge();































































        showChatNotification(name, text);































































      }































































    });































































































































    // Incoming typing events































































    channel.subscribe(TYPING_EVENT, (msg) => {































































      const d = msg?.data || {};































































      noteTyping(sanitizeName(d.name || ""));































































    });































































































































    async function loadHistory(){































































      try {































































        const history = await channel.history({ limit: 50 });































































        const items = Array.isArray(history?.items) ? history.items.slice().reverse() : [];































































        for (const item of items) {































































          const d = item?.data || {};































































          const id = String(d.id || "");































































          const name = sanitizeName(d.name || "Unknown");































































          const text = String(d.text || "").slice(0, MAX_LEN);































































          const ts = Number(d.ts || item?.timestamp || Date.now());































































































































          if (!id || !text) continue;































































          if (seenIds.has(id)) continue;































































          seenIds.add(id);































































          renderMessage({ id, name, text, ts });































































        }































































        saveCachedMessages();































































      } catch (error) {































































        console.warn("Failed to load Ably history:", error);































































      }































































    }































































































































    // Send (ONLY publish; DO NOT render here → fixes "sends twice")































































    async function send(){































































      const text = (inputEl.value || "").trim();































































      if (!text) return;































































      if (text.length > MAX_LEN) return addSystem(`Message too long (max ${MAX_LEN}).`);































































      if (!canSendNow()) return addSystem("Slow down — you’re sending too fast.");































































































































      const id = uuid();































































      const payload = { id, name: username, text, ts: Date.now() };































































































































      // clear input immediately































































      inputEl.value = "";































































      inputEl.style.height = "44px";































































































































      try{































































        await channel.publish(CHAT_EVENT, payload);































































        // We do NOT render here. We will render when Ably delivers it back.































































      }catch(e){































































        addSystem("Failed to send (not connected?).");































































        console.warn("publish failed:", e);































































      }































































    }































































































































    // typing publish (throttled)































































    inputEl.addEventListener("input", async () => {































































      inputEl.style.height = "44px";































































      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";































































































































      const now = Date.now();































































      if (now - lastTypingSentAt < TYPING_THROTTLE_MS) return;































































      lastTypingSentAt = now;































































































































      try{ await channel.publish(TYPING_EVENT, { name: username }); }catch{}































































    });































































































































    sendBtn.addEventListener("click", send);































































    inputEl.addEventListener("keydown", (e) => {































































      if (e.key === "Enter" && !e.shiftKey){































































        e.preventDefault();































































        send();































































      }































































    });































































































































    // Parent window integration for "close/reopen"































































    // Your desktop should postMessage these:































































    // - {type:"chatOpened"} when chat window shown































































    // - {type:"chatClosed"} when chat window hidden































































    // - {type:"toggleNotifications", enabled:true/false} optional































































    window.addEventListener("message", (event) => {































































      const d = event.data;































































      if (!d || !d.type) return;































































































































      if (d.type === "chatOpened"){































































        isChatWindowOpen = true;































































        resetUnread();































































        // In case it looks blank: re-render cached quickly































































        // (harmless if already visible)































































        if (messagesEl.childElementCount === 0) loadCachedMessages();































































        setTimeout(scrollToBottom, 50);































































      }































































      if (d.type === "chatClosed"){































































        isChatWindowOpen = false;































































      }































































      if (d.type === "toggleNotifications"){































































        notificationsEnabled = !!d.enabled;































































      }































































    });































































































































    // Boot































































    (async function boot(){































































      addSystem("Connecting to Ably…");































































































































      // restore session history immediately (so reopen doesn't look empty)































































      loadCachedMessages();































































      if (messagesEl.childElementCount) addSystem("Restored recent messages.");































































































































      await enterPresence();































































      await updateOnlineCount();































































































































      // ask parent for state (optional)































































      try{ window.parent.postMessage({ type:"requestChatState" }, "*"); }catch{}































































































































      addSystem("Connected. Say hi 👋");































































      updateUnreadBadge();































































































































      window.addEventListener("beforeunload", () => {































































        try{ channel.presence.leave(); }catch{}































































      });































































    })();































































  </script>































































</body>































































</html>































































